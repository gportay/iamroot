#
# Copyright 2021-2022 GaÃ«l PORTAY
#
# SPDX-License-Identifier: LGPL-2.1-or-later
#

_iamroot-shell()
{
	local cur prev words cword DEBUG_FUNCS
	_init_completion || return

	DEBUG_FUNCS=(__fstat __fxstat __fxstat64 __fxstatat __fxstatat64
		__libc_start_main __lxstat __lxstat64 __nss_files_fopen __open
		__open64 __open64_2 __open_2 __openat64_2 __openat_2 __opendir
		__opendir2 __opendirat __statfs __xmknod __xmknodat __xstat
		__xstat64 access canonicalize_file_name chdir chmod chown
		chroot creat dlmopen dlopen eaccess euidaccess execl execle
		execlp exect execv execvP execve execveat execvp execvpe
		extattr_delete_fd extattr_delete_file extattr_delete_link
		extattr_get_fd extattr_get_file extattr_get_link
		extattr_list_fd extattr_list_file extattr_list_link
		extattr_set_fd extattr_set_file extattr_set_link faccessat
		fchdir fchmod fchmodat fchown fchownat fexecve fgetxattr
		flistxattr fopen fremovexattr freopen fsetxattr fstat fstat64
		fstatat fstatat64 ftw futimesat get_current_dir_name getcwd
		getegid geteuid getgid getfh getfhat getuid getwd getxattr
		lchmod lchown lgetxattr link linkat listxattr llistxattr
		lremovexattr lsetxattr lstat lstat64 lutimes mkdir mkdirat
		mkdtemp mkfifo mkfifoat mknod mknodat mkostemp mkostemps
		mkstemp mkstemps mktemp mount name_to_handle_at nftw nmount
		open openat opendir path_resolution posix_spawn posix_spawnp
		readlink readlinkat realpath remove removexattr rename renameat
		renameat2 rmdir running_in_chroot scandir scandir64 scandir_b
		scandirat setegid seteuid setgid setuid setxattr stat stat64
		statfs statfs64 statvfs statvfs64 statx symlink symlinkat
		tempnam tmpnam tmpnam_r truncate umask umount umount2 unlink
		unlinkat unmount unshare utime utimensat utimes)

	COMMON_PATH=(/bin /sbin /usr/bin /usr/sbin /usr/local/bin
		/usr/local/sbin)

	COMMON_LIBRARY_PATH=(/lib /usr/lib /usr/local/lib)

	case "$prev" in
	--chroot)
		_filedir -d
		return
		;;
	--profile-file|--rc-file)
		_filedir
		return
		;;
	--exec)
		_filedir
		return
		;;
	--library)
		_filedir so
		return
		;;
	--path)
		local prefix realcur wordlist
		realcur="${cur##*\:}"
		prefix="${cur%$realcur}"
		for WORD in "${COMMON_PATH[@]}"
		do
			if ! [[ $prefix == *"$WORD"* ]]
			then
				wordlist+=("$WORD")
			fi
		done
		compopt -o nospace
		COMPREPLY=($(compgen -P "$prefix" -W "${wordlist[*]}" -S '\:' -- "$realcur"))
		return 0
		;;
	--library-path)
		local prefix realcur wordlist
		realcur="${cur##*\:}"
		prefix="${cur%$realcur}"
		for WORD in "${COMMON_LIBRARY_PATH[@]}"
		do
			if ! [[ $prefix == *"$WORD"* ]]
			then
				wordlist+=("$WORD")
			fi
		done
		compopt -o nospace
		COMPREPLY=($(compgen -P "$prefix" -W "${wordlist[*]}" -S '\:' -- "$realcur"))
		return 0
		;;
	--debug-fd)
		local fds
		mapfile -t fds < <(for fd in /proc/self/fd/*; do echo "${fd##*/}"; done)
		COMPREPLY=($(compgen -W "${fds[*]}" -- "$cur"))
		return 0
		;;
	--debug-allow|--debug-ignore)
		local prefix realcur wordlist
		realcur="${cur##*\|}"
		prefix="${cur%$realcur}"
		for WORD in "${DEBUG_FUNCS[@]}"
		do
			if ! [[ $prefix == *"$WORD"* ]]
			then
				wordlist+=("$WORD")
			fi
		done
		compopt -o nospace
		COMPREPLY=($(compgen -P "$prefix" -W "${wordlist[*]}" -S '\|' -- "$realcur"))
		return 0
		;;
	--exec-ignore)
		local prefix realcur wordlist
		realcur="${cur##*\|}"
		prefix="${cur%$realcur}"
		COMPREPLY=($(compgen -c -- "${realcur}"))
		for WORD in "${COMPREPLY[@]}"
		do
			if ! [[ $prefix == *"$WORD"* ]]
			then
				wordlist+=("$WORD")
			fi
		done
		compopt -o nospace
		COMPREPLY=($(compgen -P "$prefix" -W "${wordlist[*]}" -S '\|' -- "$realcur"))
		return 0
		;;
	--path-resolution-allow|--path-resolution-ignore)
		local prefix realcur wordlist
		realcur="${cur##*\|}"
		prefix="${cur%$realcur}"
		COMPREPLY=($(compgen -d -S '/' -- "${realcur}"))
		for WORD in "${COMPREPLY[@]}"
		do
			if ! [[ $prefix == *"$WORD"* ]]
			then
				wordlist+=("$WORD")
			fi
		done
		compopt -o nospace
		COMPREPLY=($(compgen -P "$prefix" -W "${wordlist[*]}" -S '\|' -- "$realcur"))
		return 0
		;;
	esac

	COMP_WORDS=("${SHELL:sh}" "${COMP_WORDS[@]:2}" "$cur")
	COMP_LINE="${COMP_WORDS[*]}"
	COMP_POINT="${#COMP_LINE}"
	_command_offset 0

	local i shell
	for (( i=0; i < "${#words[@]}"; i++ ))
	do
		if [[ "${words[i]}" == -- ]]
		then
			shell=1
			break
		fi
	done

	if [[ "$shell" != 1 ]]
	then
		COMPREPLY+=($(compgen -W "--chroot --profile-file --rc-file --path --library-path --exec --library --fatal --debug --debug-fd --debug-allow --debug-ignore --exec-ignore --path-resolution-ignore --version" -- "$cur"))
	fi
} &&
complete -F _iamroot-shell iamroot-shell
